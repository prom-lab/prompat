<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Reels - Ù…Ø´Ø§Ù‡Ø¯Ø© ÙˆÙÙˆØ²</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Tajawal', sans-serif;
        }

        :root {
            --primary: #E1306C;
            --primary-light: #FD1D7D;
            --primary-dark: #C13584;
            --secondary: #405DE6;
            --accent: #FFDC80;
            --success: #06D6A0;
            --dark: #262626;
            --light: #FFFFFF;
            --gray: #8E8E8E;
            --background: #000000;
            --glass-light: rgba(255, 255, 255, 0.1);
            --glass-dark: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-light: #FFFFFF;
            --text-gray: #A8A8A8;
            --gradient-instagram: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --border-radius: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--background);
            color: var(--text-light);
            overflow-x: hidden;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }

        .sidebar {
            width: 80px;
            background: var(--dark);
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }

        .sidebar-logo {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 3rem;
            background: var(--gradient-instagram);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            width: 100%;
            align-items: center;
        }

        .nav-item {
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            padding: 0.8rem;
            border-radius: 12px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item.active {
            background: var(--gradient-instagram);
        }

        .nav-item:hover {
            background: var(--glass-light);
        }

        .main-content {
            flex: 1;
            margin-right: 80px;
            display: flex;
            width: calc(100% - 80px);
        }

        .reels-container {
            flex: 1;
            position: relative;
            height: 100vh;
            overflow-y: auto;
            scroll-snap-type: y mandatory;
            width: 100%;
        }

        .reel-item {
            height: 100vh;
            scroll-snap-align: start;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            padding: 0;
            width: 100%;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 85vh;
            border-radius: 20px;
            overflow: hidden;
            background: #000;
            margin: 0 auto;
        }

        .video-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            border-radius: 20px;
            overflow: hidden;
        }

        .video-element {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
        }

        .embed-container {
            width: 100%;
            height: 100%;
            border-radius: 20px;
            overflow: hidden;
            background: #000;
        }

        .embed-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 20px;
        }

        .video-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #405DE6, #E1306C);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 2rem;
            border-radius: 20px;
        }

        .video-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .video-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            border-radius: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--glass-light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 2rem;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            border-radius: 0 0 20px 20px;
            z-index: 10;
        }

        .video-info {
            margin-bottom: 1rem;
        }

        .video-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .video-description {
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        .progress-container {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 20;
        }

        .circular-progress {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0deg, var(--glass-dark) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .progress-inner {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .user-points-info {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--glass-light);
            backdrop-filter: blur(20px);
            padding: 0.8rem 1rem;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            font-weight: 600;
            z-index: 20;
            text-align: center;
            min-width: 140px;
        }

        .user-name {
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .points-earned {
            color: var(--accent);
            font-size: 0.8rem;
            font-weight: 700;
        }

        .daily-points {
            font-size: 0.7rem;
            color: var(--text-gray);
            margin-top: 0.2rem;
        }

        .interaction-buttons {
            position: absolute;
            right: 1rem;
            bottom: 6rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 10;
        }

        .interaction-btn {
            background: var(--glass-light);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .interaction-btn:hover {
            background: var(--primary);
            transform: scale(1.1);
        }

        .interaction-btn.liked {
            color: var(--primary);
        }

        .interaction-count {
            text-align: center;
            font-size: 0.7rem;
            margin-top: 0.2rem;
            color: var(--text-gray);
        }

        .ads-sidebar {
            width: 300px;
            padding: 2rem 1rem;
            background: var(--dark);
            overflow-y: auto;
        }

        .ad-unit {
            background: var(--glass-dark);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--glass-border);
        }

        .ad-reel {
            background: var(--glass-dark);
            border-radius: 20px;
            margin: 1rem;
            padding: 2rem;
            text-align: center;
            border: 2px dashed var(--glass-border);
            height: 85vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--dark);
            padding: 0.8rem;
            justify-content: space-around;
            border-top: 1px solid var(--glass-border);
            z-index: 1000;
        }

        .bottom-nav-item {
            color: var(--text-light);
            font-size: 1.3rem;
            cursor: pointer;
            transition: var(--transition);
            padding: 0.5rem;
            flex: 1;
            text-align: center;
        }

        .bottom-nav-item.active {
            color: var(--primary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 1024px) {
            .ads-sidebar {
                display: none;
            }
            
            .main-content {
                margin-right: 80px;
                width: calc(100% - 80px);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                margin-right: 0;
                width: 100%;
            }
            
            .bottom-nav {
                display: flex;
            }
            
            .interaction-buttons {
                right: 1rem;
                bottom: 5rem;
            }
            
            .user-points-info {
                top: 1rem;
                right: 1rem;
                min-width: 120px;
                padding: 0.6rem 0.8rem;
            }
            
            .progress-container {
                top: 1rem;
                left: 1rem;
            }
            
            .video-container {
                height: 90vh;
                max-width: 100%;
                border-radius: 0;
            }
            
            .video-element, .embed-container {
                border-radius: 0;
            }
            
            .reel-item {
                padding: 0;
            }
            
            .video-controls {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCffrRr-wYBeiAf7GML6Xs3kQg-14mLFhQ",
            authDomain: "prompat-76c51.firebaseapp.com",
            projectId: "prompat-76c51",
            storageBucket: "prompat-76c51.firebasestorage.app",
            messagingSenderId: "663109200073",
            appId: "1:663109200073:web:9da9a15649a88028b68518",
            measurementId: "G-HKL1XTBX6H"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-logo">Reels</div>
            <div class="sidebar-nav">
                <div class="nav-item active">
                    <i class="fas fa-home"></i>
                </div>
                <div class="nav-item">
                    <i class="fas fa-search"></i>
                </div>
                <div class="nav-item">
                    <i class="fas fa-plus-square"></i>
                </div>
                <div class="nav-item">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="nav-item">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </nav>

        <main class="main-content">
            <section class="reels-container" id="reelsContainer">
                <div class="loading-message" style="text-align: center; padding: 3rem; color: var(--text-gray);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª...</p>
                </div>
            </section>

            <aside class="ads-sidebar">
                <div class="ad-unit">
                    <script type="text/javascript">
                        atOptions = {
                            'key' : '1333b27d45848599574868956a16a6ee',
                            'format' : 'iframe',
                            'height' : 300,
                            'width' : 160,
                            'params' : {}
                        };
                    </script>
                    <script type="text/javascript" src="//www.highperformanceformat.com/1333b27d45848599574868956a16a6ee/invoke.js"></script>
                </div>
                
                <div class="ad-unit">
                    <div id="container-50691a36ff5f5b69c33f81398fc8214d"></div>
                </div>
            </aside>
        </main>

        <nav class="bottom-nav">
            <div class="bottom-nav-item active">
                <i class="fas fa-home"></i>
            </div>
            <div class="bottom-nav-item">
                <i class="fas fa-search"></i>
            </div>
            <div class="bottom-nav-item">
                <i class="fas fa-plus-square"></i>
            </div>
            <div class="bottom-nav-item">
                <i class="fas fa-heart"></i>
            </div>
            <div class="bottom-nav-item">
                <i class="fas fa-user"></i>
            </div>
        </nav>
    </div>

    <script>
        let currentUser = null;
        let userData = null;
        let videos = [];
        let watchTimers = {};
        let userWatchHistory = {};
        let dailyStats = {};
        let userLikes = {};

        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Starting app...');
            initializeApp();
            setupAds();
        });

        function initializeApp() {
            console.log('ğŸ”¥ Initializing Firebase...');
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('âœ… User logged in:', user.email);
                    currentUser = user;
                    await loadUserData();
                    await loadVideos();
                    showReelsContent();
                } else {
                    console.log('âŒ No user, redirecting...');
                    window.location.href = 'index.html';
                }
            });
        }

        async function loadUserData() {
            if (!currentUser) return;

            try {
                console.log('ğŸ“¥ Loading user data...');
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    console.log('âœ… User data loaded:', userData);
                } else {
                    userData = {
                        name: currentUser.email.split('@')[0] || 'Ù…Ø³ØªØ®Ø¯Ù…',
                        points: 0
                    };
                    console.log('âš ï¸ Using default user data');
                }
                updateUserInfoDisplay();

                const watchHistoryDoc = await db.collection('userWatchHistory').doc(currentUser.uid).get();
                userWatchHistory = watchHistoryDoc.exists ? watchHistoryDoc.data() : {};
                console.log('ğŸ“Š Watch history loaded');

                const likesDoc = await db.collection('userLikes').doc(currentUser.uid).get();
                userLikes = likesDoc.exists ? likesDoc.data() : {};
                console.log('â¤ï¸ Likes data loaded');

                const today = getCurrentDate();
                const dailyStatsDoc = await db.collection('dailyStats').doc(`${currentUser.uid}_${today}`).get();
                if (dailyStatsDoc.exists) {
                    dailyStats = dailyStatsDoc.data();
                } else {
                    dailyStats = {
                        userId: currentUser.uid,
                        date: today,
                        pointsEarned: 0,
                        videosWatched: 0,
                        maxPoints: 50
                    };
                    await db.collection('dailyStats').doc(`${currentUser.uid}_${today}`).set(dailyStats);
                }
                console.log('ğŸ“ˆ Daily stats loaded');

            } catch (error) {
                console.error('âŒ Error loading user data:', error);
                userData = { name: 'Ù…Ø³ØªØ®Ø¯Ù…', points: 0 };
                userWatchHistory = {};
                userLikes = {};
                dailyStats = { pointsEarned: 0, maxPoints: 50 };
                updateUserInfoDisplay();
            }
        }

        function updateUserInfoDisplay() {
            const userInfoElements = document.querySelectorAll('.user-name');
            const pointsElements = document.querySelectorAll('.points-earned');
            const dailyPointsElements = document.querySelectorAll('.daily-points');
            
            userInfoElements.forEach(element => {
                element.textContent = userData?.name || 'Ù…Ø³ØªØ®Ø¯Ù…';
            });
            
            pointsElements.forEach(element => {
                element.textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${userData?.points || 0}`;
            });
            
            dailyPointsElements.forEach(element => {
                element.textContent = `Ø§Ù„ÙŠÙˆÙ…: ${dailyStats?.pointsEarned || 0}/${dailyStats?.maxPoints || 50}`;
            });
        }

        async function loadVideos() {
            try {
                console.log('ğŸ¬ Loading videos from Firebase...');
                const videosSnapshot = await db.collection('videos')
                    .where('active', '==', true)
                    .orderBy('createdAt', 'desc')
                    .get();

                videos = [];
                
                if (!videosSnapshot.empty) {
                    console.log('âœ… Found videos in database');
                    videosSnapshot.forEach(doc => {
                        const video = doc.data();
                        video.id = doc.id;
                        videos.push(video);
                    });
                } else {
                    console.log('âš ï¸ No videos in database, adding sample videos...');
                    await addSampleVideos();
                    await loadVideos(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                    return;
                }

                console.log(`âœ… Loaded ${videos.length} videos`);
                videos = shuffleArray(videos);
                renderVideos();

            } catch (error) {
                console.error('âŒ Error loading videos:', error);
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø§Ø³ØªØ®Ø¯Ù… ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø­Ù„ÙŠØ©
                useLocalVideos();
            }
        }

        async function addSampleVideos() {
            const sampleVideos = [
                {
                    title: "Ù…Ù†Ø§Ø¸Ø± Ø·Ø¨ÙŠØ¹ÙŠØ© Ø®Ù„Ø§Ø¨Ø©",
                    points: 5,
                    videoUrl: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4",
                    description: "Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ù†Ø§Ø¸Ø± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ø§Ù„Ø®Ù„Ø§Ø¨Ø©",
                    type: "mp4"
                },
                {
                    title: "Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ù‡Ø§Ø¯Ø¦Ø©", 
                    points: 3,
                    embedCode: '<iframe width="100%" height="315" src="https://www.youtube.com/embed/5qap5aO4i9A" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>',
                    description: "Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ù‡Ø§Ø¯Ø¦Ø© Ù„Ù„Ø§Ø³ØªØ±Ø®Ø§Ø¡",
                    type: "embed"
                }
            ];

            try {
                for (const sampleVideo of sampleVideos) {
                    const videoData = {
                        ...sampleVideo,
                        active: true,
                        views: 0,
                        likes: 0,
                        addedBy: 'system',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection('videos').add(videoData);
                }
                console.log('âœ… Sample videos added successfully');
            } catch (error) {
                console.error('Error adding sample videos:', error);
            }
        }

        function useLocalVideos() {
            console.log('ğŸ”„ Using local sample videos');
            videos = [
                {
                    id: 'video1',
                    title: 'Ù…Ù†Ø§Ø¸Ø± Ø·Ø¨ÙŠØ¹ÙŠØ© Ø®Ù„Ø§Ø¨Ø©',
                    points: 5,
                    videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4',
                    likes: 23,
                    views: 156,
                    type: 'mp4'
                },
                {
                    id: 'video2',
                    title: 'Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ù‡Ø§Ø¯Ø¦Ø©',
                    points: 3,
                    embedCode: '<iframe width="100%" height="315" src="https://www.youtube.com/embed/5qap5aO4i9A" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>',
                    likes: 15,
                    views: 89,
                    type: 'embed'
                }
            ];
            videos = shuffleArray(videos);
            renderVideos();
        }

        function renderVideos() {
            const container = document.getElementById('reelsContainer');
            console.log(`ğŸ¬ Rendering ${videos.length} videos...`);
            
            if (videos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-gray);">
                        <i class="fas fa-film" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            videos.forEach((video, index) => {
                const isWatched = userWatchHistory && userWatchHistory[video.id];
                const hasLiked = userLikes && userLikes[video.id];
                const canEarnPoints = !isWatched && dailyStats.pointsEarned < dailyStats.maxPoints;

                console.log(`ğŸ¥ Creating video ${index + 1}: ${video.title} - Type: ${video.type}`);

                const reelItem = document.createElement('div');
                reelItem.className = 'reel-item';
                reelItem.setAttribute('data-video-id', video.id);
                
                reelItem.innerHTML = `
                    <div class="video-container">
                        <div class="progress-container">
                            <div class="circular-progress" id="progress-${video.id}">
                                <div class="progress-inner">
                                    <span id="progress-text-${video.id}">0%</span>
                                </div>
                            </div>
                        </div>

                        <div class="user-points-info">
                            <div class="user-name">${userData?.name || 'Ù…Ø³ØªØ®Ø¯Ù…'}</div>
                            <div class="points-earned">Ø§Ù„Ù†Ù‚Ø§Ø·: ${userData?.points || 0}</div>
                            <div class="daily-points">Ø§Ù„ÙŠÙˆÙ…: ${dailyStats.pointsEarned || 0}/${dailyStats.maxPoints || 50}</div>
                        </div>

                        <div class="video-wrapper">
                            <div class="video-loading" id="loading-${video.id}">
                                <div class="spinner"></div>
                                <p style="margin-top: 1rem; font-size: 0.9rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...</p>
                            </div>
                            <div id="video-container-${video.id}">
                                ${video.type === 'embed' ? 
                                    `<div class="embed-container">
                                        ${video.embedCode}
                                    </div>` :
                                    video.videoUrl ? 
                                    `<video class="video-element" id="video-${video.id}" controls playsinline muted>
                                        <source src="${video.videoUrl}" type="video/mp4">
                                        Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                                    </video>` :
                                    `<div class="video-placeholder">
                                        <i class="fab fa-instagram"></i>
                                        <p>${video.title || 'ÙÙŠØ¯ÙŠÙˆ Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…'}</p>
                                        <small>${video.points} Ù†Ù‚Ø§Ø·</small>
                                    </div>`
                                }
                            </div>
                        </div>

                        <div class="video-controls">
                            <div class="video-info">
                                <div class="video-title">${video.title || 'ÙÙŠØ¯ÙŠÙˆ Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…'}</div>
                                <div class="video-description" id="desc-${video.id}">
                                    ${canEarnPoints ? `Ø´Ø§Ù‡Ø¯ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ${video.points} Ù†Ù‚Ø§Ø·` : 'ØªÙ… Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹'}
                                </div>
                            </div>
                        </div>

                        <div class="interaction-buttons">
                            <div class="interaction-btn ${hasLiked ? 'liked' : ''}" onclick="toggleLike('${video.id}')">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="interaction-count" id="likes-${video.id}">${video.likes || 0}</div>
                        </div>
                    </div>
                `;

                container.appendChild(reelItem);

                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                if (video.type === 'mp4' && video.videoUrl) {
                    setupVideoPlayer(video.id, video.videoUrl);
                    
                    if (canEarnPoints) {
                        setupVideoTracking(video.id, video.points);
                    }
                } else if (video.type === 'embed') {
                    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©
                    const loadingElement = document.getElementById(`loading-${video.id}`);
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                    
                    if (canEarnPoints) {
                        setupEmbedTracking(video.id, video.points);
                    }
                } else {
                    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙÙŠØ¯ÙŠÙˆ
                    const loadingElement = document.getElementById(`loading-${video.id}`);
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                }
            });

            addAdReels();
            console.log('âœ… All videos rendered successfully!');
        }

        function setupVideoPlayer(videoId, videoUrl) {
            const videoElement = document.getElementById(`video-${videoId}`);
            const loadingElement = document.getElementById(`loading-${videoId}`);
            
            if (!videoElement) {
                console.error(`âŒ Video element not found for: ${videoId}`);
                if (loadingElement) loadingElement.style.display = 'none';
                return;
            }

            console.log(`ğŸ¬ Setting up video player for: ${videoId}`);

            videoElement.addEventListener('loadeddata', function() {
                console.log(`âœ… Video loaded: ${videoId}`);
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            });

            videoElement.addEventListener('error', function(e) {
                console.error(`âŒ Video error for ${videoId}:`, e);
                if (loadingElement) {
                    loadingElement.innerHTML = `
                        <div style="text-align: center; color: white;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</p>
                            <button onclick="retryVideo('${videoId}')" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer;">
                                Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                            </button>
                        </div>
                    `;
                }
            });

            videoElement.addEventListener('canplay', function() {
                console.log(`ğŸ¯ Video can play: ${videoId}`);
                videoElement.play().catch(e => {
                    console.log('âš ï¸ Autoplay blocked, waiting for user interaction');
                });
            });

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ ÙˆÙ‚Øª Ù…Ø¹ÙŠÙ†
            setTimeout(() => {
                if (loadingElement && loadingElement.style.display !== 'none') {
                    loadingElement.style.display = 'none';
                }
            }, 5000);
        }

        function setupEmbedTracking(videoId, points) {
            if (userWatchHistory[videoId]) {
                console.log(`â­ï¸ Video already watched: ${videoId}`);
                return;
            }

            console.log(`ğŸ¯ Setting up embed tracking for: ${videoId}`);

            let watchTime = 0;
            const maxWatchTime = 15;
            let pointsEarned = 0;
            const maxPoints = points;

            watchTimers[videoId] = setInterval(() => {
                const videoElement = document.querySelector(`[data-video-id="${videoId}"]`);
                if (videoElement && isElementInViewport(videoElement)) {
                    watchTime++;
                    
                    const progress = Math.min((watchTime / maxWatchTime) * 100, 100);
                    updateProgressBar(videoId, progress);
                    
                    if (watchTime >= maxWatchTime && pointsEarned < maxPoints && dailyStats.pointsEarned < dailyStats.maxPoints) {
                        if (!userWatchHistory[videoId]) {
                            console.log(`ğŸ‰ Earned points for embed: ${videoId}`);
                            earnPoints(videoId, maxPoints);
                            pointsEarned = maxPoints;
                            clearInterval(watchTimers[videoId]);
                            updateProgressBar(videoId, 100);
                        }
                    }
                    
                    if (pointsEarned >= maxPoints || dailyStats.pointsEarned >= dailyStats.maxPoints) {
                        clearInterval(watchTimers[videoId]);
                        updateProgressBar(videoId, 100);
                    }
                }
            }, 1000);
        }

        function setupVideoTracking(videoId, points) {
            if (userWatchHistory[videoId]) {
                console.log(`â­ï¸ Video already watched: ${videoId}`);
                return;
            }

            console.log(`ğŸ¯ Setting up tracking for: ${videoId}`);

            let watchTime = 0;
            const maxWatchTime = 15;
            let pointsEarned = 0;
            const maxPoints = points;

            watchTimers[videoId] = setInterval(() => {
                const videoElement = document.getElementById(`video-${videoId}`);
                if (videoElement && isElementInViewport(videoElement) && !videoElement.paused) {
                    watchTime++;
                    
                    const progress = Math.min((watchTime / maxWatchTime) * 100, 100);
                    updateProgressBar(videoId, progress);
                    
                    if (watchTime % 15 === 0 && pointsEarned < maxPoints && dailyStats.pointsEarned < dailyStats.maxPoints) {
                        if (!userWatchHistory[videoId]) {
                            console.log(`ğŸ‰ Earned point for: ${videoId}`);
                            earnPoints(videoId, 1);
                            pointsEarned++;
                        }
                    }
                    
                    if (pointsEarned >= maxPoints || dailyStats.pointsEarned >= dailyStats.maxPoints) {
                        clearInterval(watchTimers[videoId]);
                        updateProgressBar(videoId, 100);
                    }
                }
            }, 1000);
        }

        function updateProgressBar(videoId, progress) {
            const progressElement = document.getElementById(`progress-${videoId}`);
            const progressText = document.getElementById(`progress-text-${videoId}`);
            
            if (progressElement && progressText) {
                progressElement.style.background = `conic-gradient(var(--primary) ${progress * 3.6}deg, var(--glass-dark) 0deg)`;
                progressText.textContent = `${Math.round(progress)}%`;
            }
        }

        async function earnPoints(videoId, points) {
            if (userWatchHistory[videoId]) {
                return;
            }

            if (dailyStats.pointsEarned + points > dailyStats.maxPoints) {
                points = dailyStats.maxPoints - dailyStats.pointsEarned;
            }

            if (points <= 0) return;

            try {
                const newPoints = (userData.points || 0) + points;
                
                await db.collection('users').doc(currentUser.uid).update({
                    points: newPoints
                });

                dailyStats.pointsEarned += points;
                dailyStats.videosWatched += 1;
                await db.collection('dailyStats').doc(`${currentUser.uid}_${getCurrentDate()}`).update({
                    pointsEarned: dailyStats.pointsEarned,
                    videosWatched: dailyStats.videosWatched
                });

                userWatchHistory[videoId] = {
                    watched: true,
                    pointsEarned: points,
                    watchedAt: new Date(),
                    watchDuration: 15
                };
                
                await db.collection('userWatchHistory').doc(currentUser.uid).set(userWatchHistory);

                // ØªØ­Ø¯ÙŠØ« Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                const videoRef = db.collection('videos').doc(videoId);
                const videoDoc = await videoRef.get();
                if (videoDoc.exists) {
                    const currentViews = videoDoc.data().views || 0;
                    await videoRef.update({
                        views: currentViews + 1
                    });
                }

                await db.collection('transactions').add({
                    userId: currentUser.uid,
                    type: 'points',
                    points: points,
                    description: `Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙŠØ¯ÙŠÙˆ Reels`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                userData.points = newPoints;
                updateUserInfoDisplay();
                showNotification(`+${points} Ù†Ù‚Ø·Ø©! ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ`);

                const descElement = document.getElementById(`desc-${videoId}`);
                if (descElement) {
                    descElement.textContent = 'ØªÙ… Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­';
                    descElement.style.color = 'var(--success)';
                }

            } catch (error) {
                console.error('Error earning points:', error);
            }
        }

        async function toggleLike(videoId) {
            try {
                if (userLikes[videoId]) {
                    showError('Ù„Ù‚Ø¯ Ø£Ø¹Ø¬Ø¨Øª Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                    return;
                }

                const videoRef = db.collection('videos').doc(videoId);
                const videoDoc = await videoRef.get();
                
                if (videoDoc.exists) {
                    const currentLikes = videoDoc.data().likes || 0;
                    await videoRef.update({
                        likes: currentLikes + 1
                    });

                    userLikes[videoId] = true;
                    await db.collection('userLikes').doc(currentUser.uid).set(userLikes);

                    document.getElementById(`likes-${videoId}`).textContent = currentLikes + 1;
                    const likeBtn = document.querySelector(`[onclick="toggleLike('${videoId}')"]`);
                    likeBtn.classList.add('liked');

                    showNotification('ØªÙ…Øª Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ø¨Ø§Ù„ÙÙŠØ¯ÙŠÙˆ!');
                }

            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }

        function addAdReels() {
            const container = document.getElementById('reelsContainer');
            
            videos.forEach((video, index) => {
                if ((index + 1) % 3 === 0 && index < videos.length - 1) {
                    const adReel = document.createElement('div');
                    adReel.className = 'reel-item';
                    adReel.innerHTML = `
                        <div class="ad-reel">
                            <h3>Ø¥Ø¹Ù„Ø§Ù†</h3>
                            <p>Ø´Ø§Ù‡Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
                            <div style="margin-top: 1rem;">
                                <div id="container-50691a36ff5f5b69c33f81398fc8214d"></div>
                            </div>
                        </div>
                    `;
                    
                    const videoElements = container.querySelectorAll('.reel-item');
                    if (videoElements[index]) {
                        container.insertBefore(adReel, videoElements[index].nextSibling);
                    }
                }
            });
        }

        function setupAds() {
            const adScript = document.createElement('script');
            adScript.async = true;
            adScript.setAttribute('data-cfasync', 'false');
            adScript.src = '//pl27889328.effectivegatecpm.com/50691a36ff5f5b69c33f81398fc8214d/invoke.js';
            document.head.appendChild(adScript);
        }

        function showReelsContent() {
            document.querySelector('.app-container').style.display = 'flex';
            console.log('âœ… Reels content shown');
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <i class="fas fa-check-circle" style="margin-left: 0.5rem;"></i>
                ${message}
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = '#EF476F';
            notification.innerHTML = `
                <i class="fas fa-exclamation-circle" style="margin-left: 0.5rem;"></i>
                ${message}
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        function getCurrentDate() {
            return new Date().toISOString().split('T')[0];
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function isElementInViewport(el) {
            if (!el) return false;
            const rect = el.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }

        function retryVideo(videoId) {
            const videoElement = document.getElementById(`video-${videoId}`);
            if (videoElement) {
                videoElement.load();
            }
        }

        window.addEventListener('beforeunload', () => {
            Object.values(watchTimers).forEach(timer => clearInterval(timer));
        });

        // Ø¥Ø¶Ø§ÙØ© event listener Ù„Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('click', function() {
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ØµÙØ­Ø©
            document.querySelectorAll('video').forEach(video => {
                video.play().catch(e => {
                    // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                });
            });
        });
    </script>
</body>
</html>